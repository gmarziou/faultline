<% content_for :navbar_stats do %>
  <div class="hidden sm:flex items-center gap-4 text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">
    <div>Today: <span class="text-slate-900 dark:text-white"><%= @occurrences_today %></span></div>
    <div class="h-4 w-px bg-slate-200 dark:bg-slate-700"></div>
    <div>This week: <span class="text-slate-900 dark:text-white"><%= @occurrences_this_week %></span></div>
  </div>
<% end %>

<header class="flex items-center justify-between mb-8">
  <h1 class="text-3xl font-bold tracking-tight">Errors</h1>
  <div class="flex items-center gap-1 bg-slate-100 dark:bg-slate-800/50 p-1 rounded-lg border border-slate-200 dark:border-slate-700">
    <% Faultline::ErrorGroup::PERIODS.keys.each do |period| %>
      <%= link_to period,
          faultline.error_groups_path(
            chart_period: period,
            status: params[:status],
            exception_class: params[:exception_class],
            q: params[:q],
            sort: params[:sort]
          ),
          class: "px-3 py-1.5 text-xs font-medium rounded-md transition-all #{@chart_period == period ? 'bg-white dark:bg-slate-700 shadow-sm text-primary' : 'hover:bg-white dark:hover:bg-slate-700'}" %>
    <% end %>
  </div>
</header>

<section class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl p-6 glow-border mb-8">
  <div class="flex items-center justify-between mb-6">
    <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider">Occurrences Over Time</h3>
    <div class="flex items-center gap-2 text-xs text-slate-400">
      <span class="w-2 h-2 rounded-full bg-primary"></span>
      <span>Total Exceptions</span>
    </div>
  </div>
  <div class="h-48">
    <% if @chart_data.any? %>
      <%
        period_config = Faultline::ErrorGroup::PERIODS[@chart_period] || {}
        granularity   = period_config[:granularity] || :day
        time_format   = case granularity
                        when :minute then "%H:%M"
                        when :hour   then "%b %d %H:00"
                        else              "%b %d"
                        end
        ov_labels = @chart_data.keys.map { |d|
          d.respond_to?(:strftime) ? d.strftime(time_format) : Time.zone.parse(d.to_s).strftime(time_format)
        }
      %>
      <canvas id="overviewChart"
              data-labels="<%= json_escape(ov_labels.to_json) %>"
              data-values="<%= json_escape(@chart_data.values.to_json) %>"></canvas>
    <% else %>
      <div class="flex items-center justify-center h-full text-slate-400 text-sm">No occurrences in this period</div>
    <% end %>
  </div>
</section>

<div class="flex flex-col lg:flex-row gap-8">
  <!-- Sidebar -->
  <aside class="w-full lg:w-64 space-y-8 flex-shrink-0">
    <div class="space-y-4">
      <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest px-2">Status</h3>
      <nav class="space-y-1">
        <%= link_to faultline.error_groups_path,
            class: "flex items-center justify-between px-3 py-2 rounded-lg transition-colors #{params[:status].blank? ? 'bg-slate-100 dark:bg-slate-800 text-primary font-medium' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'}" do %>
          <span>All</span>
          <span class="text-xs bg-slate-200 dark:bg-slate-700 px-2 py-0.5 rounded text-slate-600 dark:text-slate-300"><%= @status_counts.values.sum %></span>
        <% end %>
        <%= link_to faultline.error_groups_path(status: "unresolved"),
            class: "flex items-center justify-between px-3 py-2 rounded-lg transition-colors #{params[:status] == 'unresolved' ? 'bg-slate-100 dark:bg-slate-800 text-primary font-medium' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'}" do %>
          <span>Unresolved</span>
          <span class="text-xs px-2 py-0.5 rounded"><%= @status_counts["unresolved"] || 0 %></span>
        <% end %>
        <%= link_to faultline.error_groups_path(status: "resolved"),
            class: "flex items-center justify-between px-3 py-2 rounded-lg transition-colors #{params[:status] == 'resolved' ? 'bg-slate-100 dark:bg-slate-800 text-primary font-medium' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'}" do %>
          <span>Resolved</span>
          <span class="text-xs px-2 py-0.5 rounded"><%= @status_counts["resolved"] || 0 %></span>
        <% end %>
        <%= link_to faultline.error_groups_path(status: "ignored"),
            class: "flex items-center justify-between px-3 py-2 rounded-lg transition-colors #{params[:status] == 'ignored' ? 'bg-slate-100 dark:bg-slate-800 text-primary font-medium' : 'text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800/50'}" do %>
          <span>Ignored</span>
          <span class="text-xs px-2 py-0.5 rounded"><%= @status_counts["ignored"] || 0 %></span>
        <% end %>
      </nav>
    </div>

    <% if @exception_classes.any? %>
      <div class="space-y-4">
        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest px-2">Exception Type</h3>
        <div class="space-y-1 text-sm max-h-48 overflow-y-auto no-scrollbar">
          <% @exception_classes.each do |exception_class| %>
            <%= link_to faultline.error_groups_path(exception_class: exception_class, status: params[:status]),
                class: "block px-3 py-2 rounded-lg truncate transition-colors #{params[:exception_class] == exception_class ? 'bg-slate-100 dark:bg-slate-800 text-primary font-medium' : 'text-slate-600 dark:text-slate-400 hover:text-primary'}" do %>
              <%= exception_class.split("::").last %>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  </aside>

  <!-- Main content -->
  <div class="flex-grow space-y-4">
    <div class="flex flex-col sm:flex-row gap-4">
      <%= form_with url: faultline.error_groups_path, method: :get, local: true, class: "relative flex-grow" do %>
        <%= hidden_field_tag :status, params[:status] if params[:status].present? %>
        <%= hidden_field_tag :exception_class, params[:exception_class] if params[:exception_class].present? %>
        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xl">search</span>
        <input type="text" name="q" value="<%= params[:q] %>"
               placeholder="Search errors, paths, or messages..."
               class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 pl-10 pr-4 py-2.5 rounded-xl focus:ring-2 focus:ring-primary/20 focus:border-primary transition-all text-sm outline-none">
      <% end %>
      <div class="flex items-center gap-1 bg-slate-100 dark:bg-slate-800/50 p-1 rounded-xl border border-slate-200 dark:border-slate-700 self-start">
        <%= link_to "Recent", faultline.error_groups_path(status: params[:status], q: params[:q]),
            class: "px-4 py-1.5 text-xs font-semibold rounded-lg transition-all #{params[:sort].blank? ? 'bg-white dark:bg-slate-700 shadow-sm text-primary' : 'text-slate-500 hover:bg-white dark:hover:bg-slate-700'}" %>
        <%= link_to "Frequent", faultline.error_groups_path(status: params[:status], q: params[:q], sort: "frequent"),
            class: "px-4 py-1.5 text-xs font-semibold rounded-lg transition-all #{params[:sort] == 'frequent' ? 'bg-white dark:bg-slate-700 shadow-sm text-primary' : 'text-slate-500 hover:bg-white dark:hover:bg-slate-700'}" %>
        <%= link_to "Oldest", faultline.error_groups_path(status: params[:status], q: params[:q], sort: "oldest"),
            class: "px-4 py-1.5 text-xs font-semibold rounded-lg transition-all #{params[:sort] == 'oldest' ? 'bg-white dark:bg-slate-700 shadow-sm text-primary' : 'text-slate-500 hover:bg-white dark:hover:bg-slate-700'}" %>
      </div>
    </div>

    <!-- Error list -->
    <div class="space-y-4">
      <% if @error_groups.any? %>
        <% @error_groups.each do |error| %>
          <div class="group bg-white/50 dark:bg-slate-900/40 backdrop-blur-sm border border-slate-200 dark:border-slate-800 hover:border-primary/50 transition-all p-5 rounded-xl flex flex-col md:flex-row gap-6">
            <div class="flex-grow space-y-3">
              <div class="flex items-center gap-3">
                <% if error.recently_reopened? %>
                  <span class="px-2 py-0.5 text-[10px] font-bold uppercase tracking-widest bg-amber-500/10 text-amber-500 rounded border border-amber-500/20">Reopened</span>
                <% end %>
                <% case error.status %>
                <% when "unresolved" %>
                  <span class="px-2 py-0.5 text-[10px] font-bold uppercase tracking-widest bg-rose-500/10 text-rose-500 rounded border border-rose-500/20">Unresolved</span>
                <% when "resolved" %>
                  <span class="px-2 py-0.5 text-[10px] font-bold uppercase tracking-widest bg-emerald-500/10 text-emerald-500 rounded border border-emerald-500/20">Resolved</span>
                <% when "ignored" %>
                  <span class="px-2 py-0.5 text-[10px] font-bold uppercase tracking-widest bg-slate-500/10 text-slate-500 rounded border border-slate-500/20">Ignored</span>
                <% end %>
                <span class="text-xs text-slate-400"><%= time_ago_in_words(error.last_seen_at) %> ago</span>
              </div>
              <%= link_to faultline.error_group_path(error), class: "block" do %>
                <h2 class="text-lg font-bold text-slate-900 dark:text-white group-hover:text-primary transition-colors"><%= error.exception_class %></h2>
                <p class="text-slate-600 dark:text-slate-400 mt-1 font-mono text-sm truncate"><%= error.sanitized_message.truncate(100) %></p>
              <% end %>
              <div class="flex items-center gap-2 text-xs text-slate-400 bg-slate-50 dark:bg-slate-800/50 w-fit px-2 py-1 rounded">
                <span class="material-symbols-outlined text-sm">folder_open</span>
                <span><%= error.file_path %>:<%= error.line_number %></span>
              </div>
            </div>
            <div class="flex flex-col justify-between items-end min-w-[140px]">
              <div class="text-right">
                <div class="text-xl font-bold text-slate-900 dark:text-white"><%= error.occurrences_count %></div>
                <div class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Occurrences</div>
              </div>
              <div class="flex gap-2 mt-4 md:mt-0">
                <% if error.status == "unresolved" %>
                  <%= button_to "Resolve", faultline.resolve_error_group_path(error), method: :patch,
                      class: "px-4 py-2 text-xs font-bold text-primary border border-primary/20 hover:bg-primary/10 rounded-lg transition-all" %>
                  <%= button_to "Ignore", faultline.ignore_error_group_path(error), method: :patch,
                      class: "px-4 py-2 text-xs font-bold text-slate-400 hover:text-slate-200 hover:bg-slate-800 rounded-lg transition-all" %>
                <% elsif error.status == "resolved" %>
                  <%= button_to "Unresolve", faultline.unresolve_error_group_path(error), method: :patch,
                      class: "px-4 py-2 text-xs font-bold text-violet-400 border border-violet-400/20 hover:bg-violet-400/10 rounded-lg transition-all" %>
                <% elsif error.status == "ignored" %>
                  <%= button_to "Unresolve", faultline.unresolve_error_group_path(error), method: :patch,
                      class: "px-4 py-2 text-xs font-bold text-violet-400 border border-violet-400/20 hover:bg-violet-400/10 rounded-lg transition-all" %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <% if @total_pages > 1 %>
          <div class="pt-8">
            <%= render "faultline/shared/pagination", page: @page, total_pages: @total_pages %>
          </div>
        <% end %>
      <% else %>
        <div class="bg-white/50 dark:bg-slate-900/40 backdrop-blur-sm border border-slate-200 dark:border-slate-800 rounded-xl p-12 text-center">
          <span class="material-symbols-outlined text-5xl text-slate-300 dark:text-slate-600 mb-4 block">check_circle</span>
          <h3 class="text-lg font-medium text-slate-900 dark:text-white mb-1">No errors found</h3>
          <p class="text-sm text-slate-500 dark:text-slate-400">
            <% if params[:q].present? %>
              No errors match your search criteria.
            <% else %>
              Great job! No errors to show.
            <% end %>
          </p>
        </div>
      <% end %>
    </div>
  </div>
</div>
