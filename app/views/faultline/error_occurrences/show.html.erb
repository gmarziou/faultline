<div class="mb-6">
  <nav class="flex items-center gap-2 text-sm">
    <%= link_to "Errors", faultline.error_groups_path, class: "text-slate-500 dark:text-slate-400 hover:text-primary transition-colors" %>
    <span class="material-symbols-outlined text-slate-400 text-base">chevron_right</span>
    <%= link_to @error_group.exception_class, faultline.error_group_path(@error_group), class: "text-slate-500 dark:text-slate-400 hover:text-primary truncate max-w-xs transition-colors" %>
    <span class="material-symbols-outlined text-slate-400 text-base">chevron_right</span>
    <span class="text-slate-900 dark:text-white font-medium">Occurrence</span>
  </nav>
</div>

<!-- Header -->
<div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl overflow-hidden mb-6 glow-border">
  <div class="px-6 py-5">
    <div class="flex items-center gap-3 mb-3">
      <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-bold bg-primary/10 text-primary border border-primary/20">
        <%= @occurrence.exception_class %>
      </span>
      <span class="inline-flex items-center px-2.5 py-1 rounded-lg text-xs font-medium bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400">
        <%= @occurrence.environment %>
      </span>
      <span class="text-xs text-slate-400 ml-auto"><%= @occurrence.created_at.strftime("%b %d, %Y at %H:%M:%S") %></span>
    </div>
    <p class="text-lg text-slate-900 dark:text-white font-medium leading-relaxed"><%= @occurrence.message %></p>
  </div>
</div>

<!-- Metadata Row -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
  <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl px-4 py-4">
    <div class="flex items-center gap-2 text-slate-500 dark:text-slate-400 text-xs mb-2">
      <span class="material-symbols-outlined text-base">person</span>
      User
    </div>
    <p class="text-slate-900 dark:text-white text-sm font-medium truncate"><%= @occurrence.user_identifier || "Anonymous" %></p>
  </div>

  <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl px-4 py-4">
    <div class="flex items-center gap-2 text-slate-500 dark:text-slate-400 text-xs mb-2">
      <span class="material-symbols-outlined text-base">language</span>
      IP Address
    </div>
    <p class="text-slate-900 dark:text-white text-sm font-medium font-mono"><%= @occurrence.ip_address || "Unknown" %></p>
  </div>

  <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl px-4 py-4">
    <div class="flex items-center gap-2 text-slate-500 dark:text-slate-400 text-xs mb-2">
      <span class="material-symbols-outlined text-base">dns</span>
      Server
    </div>
    <p class="text-slate-900 dark:text-white text-sm font-medium truncate"><%= @occurrence.hostname %></p>
    <p class="text-slate-500 dark:text-slate-400 text-xs">PID: <%= @occurrence.process_id %></p>
  </div>

  <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl px-4 py-4">
    <div class="flex items-center gap-2 text-slate-500 dark:text-slate-400 text-xs mb-2">
      <span class="material-symbols-outlined text-base">schedule</span>
      When
    </div>
    <p class="text-slate-900 dark:text-white text-sm font-medium"><%= time_ago_in_words(@occurrence.created_at) %> ago</p>
  </div>
</div>

<% if @occurrence.request_url.present? %>
  <!-- Request Info -->
  <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl overflow-hidden mb-6 glow-border">
    <div class="px-4 py-3 border-b border-slate-200 dark:border-slate-800 flex items-center gap-2">
      <span class="material-symbols-outlined text-primary">link</span>
      <h2 class="text-sm font-semibold text-slate-900 dark:text-white">Request</h2>
    </div>
    <div class="p-4 space-y-4 max-h-96 overflow-y-auto">
      <div>
        <div class="flex items-center gap-2 mb-2">
          <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-primary/10 text-primary">
            <%= @occurrence.request_method %>
          </span>
        </div>
        <code class="text-xs text-slate-600 dark:text-slate-400 break-all block bg-slate-50 dark:bg-slate-800/50 p-2 rounded-lg"><%= @occurrence.request_url %></code>
      </div>

      <% if @occurrence.user_agent.present? %>
        <div>
          <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">User Agent</p>
          <p class="text-xs text-slate-700 dark:text-slate-300 break-all"><%= @occurrence.user_agent %></p>
        </div>
      <% end %>

      <% if @occurrence.parsed_request_params.any? %>
        <div>
          <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Parameters</p>
          <pre class="text-xs bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 p-3 rounded-lg overflow-x-auto font-mono"><code><%= JSON.pretty_generate(@occurrence.parsed_request_params) %></code></pre>
        </div>
      <% end %>

      <% if @occurrence.parsed_request_headers.any? %>
        <div>
          <p class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-2">Headers</p>
          <pre class="text-xs bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 p-3 rounded-lg overflow-x-auto font-mono"><code><%= JSON.pretty_generate(@occurrence.parsed_request_headers) %></code></pre>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<% if @occurrence.error_contexts.any? %>
  <!-- Custom Context -->
  <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl overflow-hidden mb-6 glow-border">
    <div class="px-4 py-3 border-b border-slate-200 dark:border-slate-800 flex items-center gap-2">
      <span class="material-symbols-outlined text-violet-500">sell</span>
      <h2 class="text-sm font-semibold text-slate-900 dark:text-white">Custom Context</h2>
    </div>
    <div class="divide-y divide-slate-100 dark:divide-slate-800">
      <% @occurrence.error_contexts.each do |context| %>
        <div class="px-4 py-3">
          <div class="flex items-start gap-4">
            <span class="text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider w-28 flex-shrink-0 pt-0.5"><%= context.key %></span>
            <div class="flex-1 min-w-0">
              <% parsed = context.parsed_value %>
              <% if parsed.is_a?(Hash) || parsed.is_a?(Array) %>
                <pre class="text-xs bg-slate-50 dark:bg-slate-800/50 text-slate-700 dark:text-slate-300 p-3 rounded-lg overflow-x-auto font-mono"><code><%= JSON.pretty_generate(parsed) %></code></pre>
              <% else %>
                <span class="text-sm text-slate-900 dark:text-white font-mono"><%= parsed %></span>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<% source_context = @occurrence.source_context %>
<% has_locals = @occurrence.parsed_local_variables.any? %>
<% has_source = source_context.present? %>

<% if has_source || has_locals %>
  <!-- Debugger Inspector: Source + Variables Side by Side -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
    <!-- Source Code Panel -->
    <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl overflow-hidden glow-border">
      <div class="px-4 py-3 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="material-symbols-outlined text-primary text-base">code</span>
          <h2 class="text-sm font-semibold text-slate-900 dark:text-white">Source</h2>
        </div>
        <% if has_source %>
          <span class="text-xs text-slate-500 dark:text-slate-400 font-mono truncate max-w-xs"><%= source_context[:file_path] %></span>
        <% end %>
      </div>
      <div class="overflow-x-auto bg-slate-50 dark:bg-slate-800/30">
        <% if has_source %>
          <table class="w-full">
            <tbody class="font-mono text-xs">
              <% source_context[:lines].each do |line| %>
                <tr class="<%= line[:current] ? 'bg-rose-100 dark:bg-rose-900/30 border-l-2 border-rose-500' : 'hover:bg-slate-100 dark:hover:bg-slate-800/50' %>">
                  <td class="px-3 py-0.5 text-right select-none w-12 border-r border-slate-200 dark:border-slate-700 <%= line[:current] ? 'text-rose-600 dark:text-rose-400 font-bold bg-rose-50 dark:bg-rose-900/20' : 'text-slate-400' %>">
                    <%= line[:number] %>
                  </td>
                  <td class="px-2 py-0.5 w-4 <%= line[:current] ? 'text-rose-500' : '' %>">
                    <%= line[:current] ? '→' : '' %>
                  </td>
                  <td class="pr-4 py-0.5 whitespace-pre text-slate-700 dark:text-slate-300"><%= highlight_ruby(line[:code]) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <div class="p-8 text-center text-slate-400 text-sm">
            <span class="material-symbols-outlined text-3xl mb-2 block">code_off</span>
            <p>Source not available</p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Variables Inspector Panel -->
    <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl overflow-hidden glow-border">
      <div class="px-4 py-3 border-b border-slate-200 dark:border-slate-800 flex items-center gap-2">
        <span class="material-symbols-outlined text-amber-500 text-base">database</span>
        <h2 class="text-sm font-semibold text-slate-900 dark:text-white">Variables</h2>
        <span class="text-xs text-slate-400">at raise point</span>
      </div>
      <div class="overflow-y-auto max-h-80">
        <% if has_locals %>
          <table class="w-full text-xs">
            <thead class="bg-slate-50 dark:bg-slate-800/50 sticky top-0">
              <tr>
                <th class="px-3 py-2 text-left text-slate-500 dark:text-slate-400 font-semibold uppercase tracking-wider w-1/3">Name</th>
                <th class="px-3 py-2 text-left text-slate-500 dark:text-slate-400 font-semibold uppercase tracking-wider">Value</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 dark:divide-slate-800 font-mono">
              <% @occurrence.parsed_local_variables.each do |name, value| %>
                <tr class="hover:bg-amber-50/50 dark:hover:bg-amber-900/10">
                  <td class="px-3 py-2 text-amber-600 dark:text-amber-400 font-medium align-top whitespace-nowrap"><%= name %></td>
                  <td class="px-3 py-2 text-slate-700 dark:text-slate-300 align-top">
                    <div class="var-tree-root" data-value="<%= value.to_json.gsub('"', '&quot;') %>"></div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        <% else %>
          <div class="p-8 text-center text-slate-400 text-sm">
            <span class="material-symbols-outlined text-3xl mb-2 block">variables</span>
            <p>No local variables captured</p>
          </div>
        <% end %>
      </div>
    </div>

    <script>
    (function() {
      function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      function getPreview(value) {
        if (value === null) return 'nil';
        if (Array.isArray(value)) return `Array (${value.length} item${value.length !== 1 ? 's' : ''})`;
        if (typeof value === 'object') {
          const keys = Object.keys(value);
          return `Object (${keys.length} key${keys.length !== 1 ? 's' : ''})`;
        }
        return String(value);
      }

      function renderValue(value, depth = 0) {
        const indent = depth > 0 ? `padding-left: ${depth * 12}px;` : '';

        if (value === null) {
          return `<span class="text-slate-400">nil</span>`;
        }

        if (typeof value === 'boolean') {
          return `<span class="text-orange-600 dark:text-orange-400">${value}</span>`;
        }

        if (typeof value === 'number') {
          return `<span class="text-blue-600 dark:text-blue-400">${value}</span>`;
        }

        if (typeof value === 'string') {
          if (value.startsWith('[') && value.includes('#<')) {
            return `<span class="text-slate-400 italic">${escapeHtml(value)}</span>`;
          }
          const truncated = value.length > 100 ? value.substring(0, 100) + '...' : value;
          return `<span class="text-emerald-600 dark:text-emerald-400">"${escapeHtml(truncated)}"</span>`;
        }

        if (Array.isArray(value)) {
          if (value.length === 0) {
            return `<span class="text-purple-600 dark:text-purple-400">[]</span>`;
          }
          return renderCollapsible(value, 'array', depth);
        }

        if (typeof value === 'object') {
          const keys = Object.keys(value);
          if (keys.length === 0) {
            return `<span class="text-purple-600 dark:text-purple-400">{}</span>`;
          }
          return renderCollapsible(value, 'object', depth);
        }

        return `<span class="text-slate-600 dark:text-slate-400">${escapeHtml(String(value))}</span>`;
      }

      function renderCollapsible(value, type, depth) {
        const isArray = type === 'array';
        const preview = getPreview(value);
        const openBrace = isArray ? '[' : '{';
        const closeBrace = isArray ? ']' : '}';

        const toggleId = `toggle-${Math.random().toString(36).substr(2, 9)}`;

        let html = `
          <span class="var-tree-node" data-expanded="false" data-toggle-id="${toggleId}">
            <span class="var-tree-toggle cursor-pointer select-none inline-flex items-center gap-1 hover:bg-slate-100 dark:hover:bg-slate-800 rounded px-0.5 -mx-0.5" onclick="window.toggleVarTree('${toggleId}')">
              <span class="var-tree-arrow text-slate-400 text-[10px] transition-transform duration-150">▶</span>
              <span class="text-purple-600 dark:text-purple-400">${openBrace}</span>
              <span class="text-slate-500 dark:text-slate-400">${preview}</span>
              <span class="text-purple-600 dark:text-purple-400">${closeBrace}</span>
            </span>
            <div class="var-tree-content hidden mt-1 pl-3 border-l border-slate-200 dark:border-slate-700 ml-1">
        `;

        if (isArray) {
          value.forEach((item, index) => {
            html += `
              <div class="py-0.5">
                <span class="text-slate-400">${index}:</span> ${renderValue(item, depth + 1)}
              </div>
            `;
          });
        } else {
          Object.entries(value).forEach(([key, val]) => {
            html += `
              <div class="py-0.5">
                <span class="text-slate-500 dark:text-slate-400">${escapeHtml(key)}:</span> ${renderValue(val, depth + 1)}
              </div>
            `;
          });
        }

        html += `
            </div>
          </span>
        `;

        return html;
      }

      window.toggleVarTree = function(toggleId) {
        const node = document.querySelector(`[data-toggle-id="${toggleId}"]`);
        if (!node) return;

        const isExpanded = node.dataset.expanded === 'true';
        const content = node.querySelector('.var-tree-content');
        const arrow = node.querySelector('.var-tree-arrow');

        if (isExpanded) {
          node.dataset.expanded = 'false';
          content.classList.add('hidden');
          arrow.style.transform = 'rotate(0deg)';
        } else {
          node.dataset.expanded = 'true';
          content.classList.remove('hidden');
          arrow.style.transform = 'rotate(90deg)';
        }
      };

      document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.var-tree-root').forEach(function(root) {
          try {
            const value = JSON.parse(root.dataset.value);
            root.innerHTML = renderValue(value, 0);
          } catch (e) {
            root.innerHTML = `<span class="text-slate-400 italic">Unable to parse value</span>`;
          }
        });
      });
    })();
    </script>
  </div>
<% end %>

<!-- Stack Trace (Full Width) -->
<div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl overflow-hidden glow-border">
  <div class="px-4 py-3 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between">
    <div class="flex items-center gap-2">
      <span class="material-symbols-outlined text-primary">view_list</span>
      <h2 class="text-sm font-semibold text-slate-900 dark:text-white">Stack Trace</h2>
    </div>
    <span class="text-xs text-slate-500 dark:text-slate-400"><%= @occurrence.parsed_backtrace.count %> frames</span>
  </div>
  <div class="p-4 bg-slate-50 dark:bg-slate-800/30 overflow-x-auto">
    <% if @occurrence.parsed_backtrace.any? %>
      <div class="space-y-0.5 font-mono text-xs">
        <% @occurrence.parsed_backtrace.each_with_index do |line, index| %>
          <% is_app_line = line.include?(Rails.root.to_s) && !line.include?("/gems/") %>
          <% clean_line = line.sub(Rails.root.to_s + "/", "") %>
          <div class="group flex items-start gap-3 <%= is_app_line ? 'bg-primary/5 dark:bg-primary/10 -mx-2 px-2 py-1.5 rounded border-l-2 border-primary' : 'py-1 -mx-2 px-2' %>">
            <span class="text-slate-400 select-none w-6 text-right flex-shrink-0"><%= index + 1 %></span>
            <span class="<%= is_app_line ? 'text-slate-800 dark:text-slate-200' : 'text-slate-500 dark:text-slate-400' %> break-all">
              <% if clean_line =~ /^(.+):(\d+):in `(.+)'$/ %>
                <span class="<%= is_app_line ? 'text-slate-700 dark:text-slate-300' : 'text-slate-500 dark:text-slate-400' %>"><%= $1 %></span><span class="text-slate-400">:</span><span class="text-violet-600 dark:text-violet-400"><%= $2 %></span><span class="text-slate-400">:in </span><span class="text-primary">`<%= $3 %>'</span>
              <% else %>
                <%= clean_line %>
              <% end %>
            </span>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="text-center py-8">
        <span class="material-symbols-outlined text-3xl text-slate-400 mb-2 block">layers_clear</span>
        <p class="text-sm text-slate-500 dark:text-slate-400">No backtrace available</p>
      </div>
    <% end %>
  </div>
</div>
